#!/bin/bash
set -e

# DATABASE_URL からホストとポートを抽出
DB_HOST=$(echo $DATABASE_URL | sed -e 's|.*://.*:.*@\([^:/]*\).*|\1|')
DB_PORT=$(echo $DATABASE_URL | sed -e 's|.*://.*:.*@[^:/]*:\([0-9]*\).*|\1|')

echo "Waiting for database at $DB_HOST:$DB_PORT ..."
until nc -z $DB_HOST $DB_PORT; do
  sleep 1
done

echo "Running migrations..."
bundle exec rails db:migrate

exec "$@"
