#!/bin/bash
set -e

# DATABASE_URL からホスト名取り出し
DB_HOST=$(echo $DATABASE_URL | sed -E 's|.*://[^@]+@([^/:]+).*|\1|')
DB_PORT=5432

echo "Waiting for Postgres at $DB_HOST:$DB_PORT ..."

# Postgres が ready になるまで待つ
until pg_isready -h "$DB_HOST" -p "$DB_PORT"; do
  echo "Postgres is unavailable - waiting..."
  sleep 2
done

echo "Postgres is up!"

# ----------------------------------------------------------
# DB migrate
# ----------------------------------------------------------
echo "== Running migrations =="
bundle exec rails db:migrate

# ----------------------------------------------------------
# 初回だけ seed を実行（seed_done が無いときだけ）
# ----------------------------------------------------------
SEED_FLAG="/rails/tmp/seed_done"

echo "== Running seed (force) =="
bundle exec rails db:seed || true


# ----------------------------------------------------------
# Rails 起動
# ----------------------------------------------------------
echo "Starting app..."
exec "$@"
